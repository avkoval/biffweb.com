---
description: I've created an example repo that starts with a fresh Biff project and then modifies it to use Postgres instead of XTDB, for those who would like to use a traditional RDBMS.
slug: how-to-use-postgres-with-biff
title: How to use Postgres with Biff
image: https://platypub.sfo3.cdn.digitaloceanspaces.com/4bea0bc9-77d6-45d3-91b5-9a4f5d5df0e2
published: 2023-11-22T13:15:34 PM
content-type: html
---

<p>I've created <a href="https://github.com/jacobobryant/biff-postgres">an example repo</a> that starts with a fresh Biff project and then modifies it to use Postgres instead of XTDB, for those who would like to use a traditional RDBMS. If you'd like to use Datomic or any other database, you can also use this as a more general guide for what parts of your project will need to be changed. If you're unfamiliar with XTDB, <a href="https://biffweb.com/p/xtdb-compared-to-other-databases/">here's some background information</a> on why it's the default in Biff.</p>
<p>I've split the steps up into <a href="https://github.com/jacobobryant/biff-postgres/commits/master">separate commits</a>; you can read those and apply the same changes in your own project (be sure to read the commits from bottom to top). I've written commentary on the changes below.</p>
<p>Also: since <a href="https://www.xtdb.com/v2">XTDB v2</a> is adding SQL as a first-class citizen, when that becomes stable I'll probably merge a lot of these changes into Biff's default template project (sans the actual Postgres bits). SQL would be the default since more people are familiar with it, but those who want to (including me!) can easily switch to Datalog.</p>
<h3>1. Start a new project</h3>
<p><a href="https://biffweb.com/docs/get-started/new-project/">Pretty straightforward</a>. I've used&nbsp;<code>com.biffweb.example.postgres</code> for the main namespace.</p>
<h3>2. Make `clj -M:dev dev` start a Postgres container with Docker</h3>
<p><a href="https://github.com/jacobobryant/biff-postgres/commit/870d669a6f4525fc253560713806bf34a5ccee2f">Diff</a>. I copied over <a href="https://github.com/jacobobryant/biff/blob/165b8aa11d47da5535b2267db51f32e838b6e19e/libs/tasks/src/com/biffweb/tasks.clj#L258">the source</a> for the regular <code>clj -M:dev dev</code> command, updated namespaces appropriately, and then had it call a new <code>start-postgres</code> function in the background. That function will run <code>docker pull postgres</code> if needed and start up a Postgres container using the configuration you specify. The container will be deleted when you stop your app (Ctrl-C), but data will be persisted to the <code>storage/postgres</code> directory.</p>
<p>You'll need to have Docker set up already. As long as you can run <code>docker ps</code> successfully you should be good to go. After making the above changes, run <code>clj -M:dev dev</code> and make sure you don't get any error messages. You should be able to get an interactive prompt with&nbsp; <code>psql postgresql://user:abc123@localhost:5432/main</code>.</p>
<h3>3. Connect to Postgres from the REPL</h3>
<p><a href="https://github.com/jacobobryant/biff-postgres/commit/64b1eabd94bbe9066743536a131b019f25332fcb">Diff</a>. I've added a <code>use-postgres</code> component that will run migrations on app startup, via a very simple approach <a href="https://clojureverse.org/t/how-do-you-do-database-migration-evolution/2005/2">courtesy of pesterhazy</a>. The <code>migrations.sql</code> file creates all the tables corresponding to the existing schema both for <a href="https://github.com/jacobobryant/biff/blob/165b8aa11d47da5535b2267db51f32e838b6e19e/starter/src/com/example/schema.clj">the starter app</a> and <a href="https://github.com/jacobobryant/biff/blob/165b8aa11d47da5535b2267db51f32e838b6e19e/src/com/biffweb/impl/auth.clj#L262">for the authentication module</a>. I'm using <a href="https://github.com/seancorfield/next-jdbc">next.jdbc</a> as the Postgres client. I'm not using any SQL wrapper libs like <a href="https://github.com/seancorfield/honeysql">HoneySQL</a> or <a href="https://www.hugsql.org/">HugSQL</a>, but you can add them yourself if desired.</p>
<p><strong>Note:</strong> the diff includes a <code>resources/config.template.env</code> file which defines a <code>DEV_POSTGRES_URL</code> environment variable. You'll need to add that variable to <code>config.env</code>.</p>
<p>In <code>dev/repl.clj</code>, the XTDB examples have been replaced with Postgres examples. After starting up the app with <code>clj -M:dev dev</code>, you should be able to evaluate them via the REPL.</p>
<p>There is also a <code>com.biffweb.example.postgres.util.postgres</code> namespace which contains some functions used in the following sections.</p>
<h3>4. Copy over the authentication module code</h3>
<p><a href="https://github.com/jacobobryant/biff-postgres/commit/ba26c09d1bc1ec07389a47201f9ddee3193c3ebc">Diff</a>. Biff's authentication module assumes you're using XTDB. We'll copy-and-paste it into our project so that we can modify it to use Postgres.</p>
<p><a href="https://github.com/jacobobryant/biff/blob/165b8aa11d47da5535b2267db51f32e838b6e19e/src/com/biffweb/impl/auth.clj">The original module</a> uses a bunch of <code>com.biffweb.impl.*</code> namespaces which are not part of Biff's public API. All the functions are aliased in the public <code>com.biffweb</code> namespace however, so we can find-and-replace all the functions over to that.</p>
<h3>5. Modify the authentication module to use Postgres</h3>
<p><a href="https://github.com/jacobobryant/biff-postgres/commit/4830dc5dc32eb0706cca10c881535be10da7ee3b">Diff</a>. This a fairly mechanical transformation; we just look for all the places XTDB is used and translate that code to Postgres.</p>
<p>The original module had&nbsp;<code>:biff.auth/get-user-id</code> and <code>:biff.auth/new-user-tx</code> options which could be used to override the default implementations. Since the module is part of our project, there's no need for those options. If you want to change your user-creation code, you can just update&nbsp;<code>util-pg/new-user-statement</code>.</p>
<p>At this point, you should be able to visit <code>localhost:8080</code> and log in to the app.</p>
<h3>6. Modify the rest of your app to use Postgres</h3>
<p><a href="https://github.com/jacobobryant/biff-postgres/commit/16b06983d034b47c7cc8f5ed00bbd79a3dde80eb">Diff</a>. Basically the same thing as the previous step, but for the remaining parts of the codebase. I also renamed&nbsp;<code>:com.biffweb.example.postgres/chat-clients</code> to <code>:example/chat-clients</code> for convenience. I'll admit, some of these diffs are reminding me that even Biff's&nbsp;<code>submit-tx</code> wrapper is not as succinct as it could be for common use-cases.</p>
<p>This diff isn't a complete 1:1 translation because I haven't added an equivalent to XTDB's transaction listeners. Maybe there's a not-terribly-complicated way to add transaction listeners to Postgres (?), but I suspect if you want similar functionality, you'll want to add some queues (either <a href="https://www.startpage.com/do/dsearch?query=postgres+queues">via Postgres</a>, or you could throw in Redis...) and publish/subscribe to those.</p>
<p>Normally, the starter Biff app uses transaction listeners to watch for new chat messages. Whenever a message comes in, the app sends it to all the currently connected clients via websocket. This works even if you have multiple web servers; each web server will send the chat message to their own set of clients.</p>
<p>In this Postgres repo, I've modified the <code>send-message</code> function (which normally just inserts new chat messages into XTDB) so that it also pushes new messages to websocket clients. This will work fine as long as you only have one web server, which I'm sure is the most common case for Biff users anyway.</p>
<p>The app should be fully functional now; head over to <code>localhost:8080</code> again and give it a spin.</p>
<h3>7. Remove the XTDB dependency</h3>
<p><a href="https://github.com/jacobobryant/biff-postgres/commit/38cfeb0b2d189dbc6ce2ab57d71c6881e3d9de4a">Diff</a>. Now that all of our app's functionality has been migrated over to Postgres, we can remove any lingering XTDB usages, particularly the <code>use-xt</code> and <code>use-tx-listener </code>components. I've also set the <code>:biff/merge-context-fn</code> system map key to <code>identity</code>.&nbsp;The default function for that key uses the <code>xtdb.api/db</code> function to insert database objects into incoming Ring requests.</p>
<p>The final step is to exclude XTDB from our <code>deps.edn</code> dependencies. I haven't bothered to split Biff up into separate libraries that can be mixed-and-matched. Instead, I've created a <code>com.biffweb/xtdb-mock</code> library which includes replacements for all of the XTDB functions that Biff calls. If you actually call any of them, they throw an exception. Once you add this library to your dependencies, you can safely add <code>com.xtdb/xtdb-core</code> etc. to the <code>:exclusions</code> key for <code>com.biffweb/biff</code>.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>Appendix: Biff's approach to project template customization</h2>
<p>Applying these changes manually will be fairly tedious, but at least it's easier than figuring out how to do it all on your own ðŸ™‚. For a new project, you could just fork this repo and change the namespaces, but there are a couple advantages if you instead create a new project&nbsp;<a href="https://biffweb.com/docs/get-started/new-project/">the regular way</a> and then apply the changes manually:</p>
<ul>
<li>You're guaranteed to be on the latest version of Biff (including any updates to the app template). I'm not planning to keep this repo up-to-date with new versions of Biff.</li>
<li>You can combine this with other changes if you want, e.g. I'll soon be writing another how-to guide that shows how to replace/complement htmx with <a href="https://day8.github.io/re-frame/re-frame/">re-frame</a>.</li>
<li>You don't have to change the namespaces manually (including keyword namespaces in various places, like the config file).</li>
</ul>
<p>(If you decide to fork this repo anyway, we can still be friends.)</p>
<p>I think leaving this as a manual process <a href="https://biffweb.com/p/philosophy-of-biff/">fits well with Biff</a>, since I expect most Biff users will stick with the default stack anyway and I'd prefer to focus most my efforts there. This is probably the main conceptual difference between Biff and&nbsp;<a href="https://kit-clj.github.io/">Kit</a>, by the way. If you're interested in a framework that has robust support for automatically modifying the stack, even after you've created your project, then&nbsp;<a href="https://yogthos.net/posts/2022-01-08-IntroducingKit.html">Kit's module system</a> is definitely worth checking out.</p>
<p>That being said, going through this process has given me some ideas for some conventions that Biff could adopt around 3rd-party project templates. If you want to create and maintain one of those, feel free to message me or ask about it on <code>#biff</code>.</p>